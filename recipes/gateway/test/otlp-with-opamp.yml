description: |
  This recipe does 2 things:
  - Receives OTLP data over HTTP (on port 4318) and gRPC (on port 4317) and exports it to Elasticsearch.
  - Spins up an OpAMP Server (on port 4320), used to make Central Configuration work with the EDOT Agents.
  
  The full OpAMP endpoint to use is: http://localhost:4320/v1/opamp
args:
  elastic_endpoint:
    description: Your Elasticsearch endpoint
    env: ELASTIC_URL
  elastic_api_key:
    description: Your Elasticsearch API Key
    env: ELASTIC_API_KEY
const:
  otlp_http_port: 4318
  otlp_grpc_port: 4317
  opamp_port: 4320
components:
  otlp:
    source: receivers/otlp.yml
    configurations: [ http, grpc ]
    vars:
      http_port: $const.otlp_http_port
      grpc_port: $const.otlp_grpc_port
  elasticapm-connector:
    source: connectors/elasticapm.yml
  elasticsearch-exporter:
    source: exporters/elasticsearch.yml
    configurations: [insecure]
    vars:
      elastic_endpoint: $args.elastic_endpoint
      elastic_api_key: $args.elastic_api_key
  elasticapm-processor:
    source: processors/elasticapm.yml
  batch:
    source: processors/batch.yml
  debug-exporter:
    source: exporters/debug.yml
  bearerauth:
    source: extensions/bearertokenauth.yml
    vars:
      api_key: $args.elastic_api_key
  apmconfig:
    source: extensions/apmconfig.yml
    vars:
      endpoint: $args.elastic_endpoint
      authenticator: $components.bearerauth
      http_port: $const.opamp_port
service:
  extensions: [ $components.bearerauth, $components.apmconfig ]
  pipelines:
    traces:
      receivers: [ $components.otlp ]
      processors: [ $components.batch, $components.elasticapm-processor ]
      exporters: [ $components.debug-exporter, $components.elasticapm-connector, $components.elasticsearch-exporter ]
    logs:
      receivers: [ $components.otlp ]
      processors: [ $components.batch, $components.elasticapm-processor ]
      exporters: [ $components.debug-exporter, $components.elasticapm-connector, $components.elasticsearch-exporter ]
    metrics:
      receivers: [ $components.otlp ]
      processors: [ $components.batch, $components.elasticapm-processor ]
      exporters: [ $components.debug-exporter, $components.elasticsearch-exporter ]
    metrics/aggregated-otel-metrics:
      receivers: [ $components.elasticapm-connector ]
      processors: [ ]
      exporters: [ $components.debug-exporter, $components.elasticsearch-exporter ]